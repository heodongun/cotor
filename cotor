#!/bin/bash
# Cotor CLI wrapper script

# Get the real path of this script (follow symlinks)
SCRIPT_PATH="$(readlink -f "$0" 2>/dev/null || realpath "$0" 2>/dev/null || echo "$0")"
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"

# Determine project version from gradle.properties
APP_VERSION=$(grep -E '^version=' "$SCRIPT_DIR/gradle.properties" | head -n 1 | cut -d'=' -f2 | tr -d '\r')
[ -z "$APP_VERSION" ] && APP_VERSION="1.0.0"

# Path to the shaded JAR file (built via shadowJar)
JAR_PATH="$SCRIPT_DIR/build/libs/cotor-${APP_VERSION}-all.jar"

# Build the CLI if the shaded JAR is missing
if [ ! -f "$JAR_PATH" ]; then
    echo "Building cotor CLI (./gradlew shadowJar)..."
    if [ -x "$SCRIPT_DIR/gradlew" ]; then
        (cd "$SCRIPT_DIR" && ./gradlew shadowJar) || exit 1
    else
        echo "Error: gradlew not found in $SCRIPT_DIR"
        exit 1
    fi
fi

# Check if Java is installed
if ! command -v java &> /dev/null; then
    echo "Error: Java is not installed or not in PATH"
    echo "Please install JDK 17 or higher"
    exit 1
fi

# Run the JAR with all arguments passed to this script
java -jar "$JAR_PATH" "$@"
